---
title: Dubtitler 初步设想
date: 2016-05-19 14:00:00
cover: '1.jpg'
category: "Dubtitler"
tags:
    - JavaScript
---

## 主要问题：
1. HTML5支持的播放器仅支持H.264编码的MP4文件格式
    这个问题没法解决。  
    搜索了很久，HTML5播放视频的格式，取决于浏览器。多数主流浏览器都只支持MP4,WebM，播放avi需要很多其他的东西。第三方的播放器videojs，也是这里要使用的播放器库，有插件通过java来支持avi和其他媒体格式，但是这个作者在放出第一版不久就因为一些没办法解决的问题放弃更新了，致命的是这个java版本的播放器不仅难以支持外挂字幕，还有其他很多的问题。因此我也放弃强行支持avi了，这是一个除了体积稍微小一点，没有其他优点的视频格式。  
    片源的格式取决于压制组的输出格式，DIMENSION的初版输出格式一般都是`.avi`，这一点我没办法控制。我只能接到片源之后，自己使用格式工厂转成`.mp4`，以我I5 4200H @2.8GHZ 的CPU，转一集183MB的盲点大概需要13分钟，不勾多线程反而会快一点点，但是不管怎么说都在10分钟以上。悲观估计在15分钟以内都可以接受。如果DL要求非常高，或者片源不能提前cc发放，那么...

<!--more-->

2. 如何更新WebVTT文件/更新修改过后的字幕
    问题在于，在保存文件之后，如何向服务器再发一次请求获取新的字幕文件，并且在播放过程中无缝地替换。  
    这个问题纠结了好久，其实它是另一个问题：要不要用服务器。  
    这个工具的初衷是尽量简单地让不能很好运行TM的同学，在翻译字幕的时候得到与使用TM类似的体验，或者说就是有选择地实现TM的功能，**在一个可以轻松跨平台而不会产生兼容性问题的基础上**。  
    使用服务器的一大好处是，大家无需操心它的版本更新问题，部署在服务器上可以保证你时刻使用到的是最新的版本。
    同时它也有一些问题，比如——如果服务器挂了会坑到人，而我又没办法及时地获取服务器状态并修复。
    不使用服务器的好处是：足够简单。但是要知道这样所有东西都是静态的了，那么一旦出现了个小bug，出现了任何问题，使得该工具无法正常使用或者得不到正确的结果，当然这是可以修复的，然而这个时候它就不够简单了。
    暂行的办法是，不再追求实时地更新视频的内置字幕了。我准备直接使用一个透明的div添加在视频块的固定位置上，这样显示字幕的同步性会好很多。而且我想使用angular，它的特性也很好地支持了这一种做法。
    不使用`<video>`标签的内置字幕元素，那么就不需要使用WebVTT格式的文件了。很多问题都可以解决了。

3. 如何保存字幕为SRT文件
    我准备使用HTML5 filesystem API写入一个文件。但是这个想法最终并不一定会实现，可以肯定的是，在我们点击保存字幕的按钮时，一定会生成一个文字域包含所有已经修改过的字幕。至少你可以通过复制粘贴来手动新建一个srt文件。  
    HTML5 Filesystem API是一个有些争议的东西，目前只有Chrome有支持它，而又有消息说它早已被Google放弃。O'Reilly出版的一本API说明，日期还在11年。所以我不确定是否有必要添加对这一功能的支持。

## 字幕处理
### 字幕的分行显示
字幕格式要求

```
编号: 8
时间轴: 00:00:16,320 --> 00:00:18,010
中文字幕: 我们遇到了地...
英文字幕: I'll tell you what, we're having an earth...
```
特殊地：
```
编号: 6
时间轴: 00:00:30,000 --> 00:00:35,000
单行字幕: {\an3}{\pos(360,230)}后期：bongpong
```
主要的问题是，两行字幕中间的换行符不应该被忽略，如果不加修改，JS显然会这么做。

### 字幕的高亮显示

1. srt时间轴的格式：`HH:MM:SS,xxx`
    vtt时间轴的格式：`HH:MM:SS.xxx`
    要求各时间基数使用不同颜色显示。包括毫秒。
2. 代码：`{\an8}`代码使用单独颜色显示，包括但不限于这类，一切形如`{\\.+}`这类的代码段都要高亮显示
3. 引用：字幕中的单双引号，使用单独颜色显示
4. 对话：字幕中表示对话的`-`使用单独颜色表示
5. 命名实体高亮： 这是一个比较麻烦的功能。命名实体识别本身就是一个（学术）问题。另一个问题是我可能没有办法再将它限制在没有服务器的纯内存应用中了。不管怎么说，我们提交的几百行字幕总是需要时间经过后台的一些处理，才能识别出其中的每一个命名实体。这里我暂且使用最简单的规则：
    a. 中文行中的非代码英文单词，和英文行中句首的首字母大写词。
    b. 字典：`Dr.`, `Mr.`, `Mrs.`, `Sgt.`, `Pvt.`, `Cpl.`, `Maj.`, `Ltc.`, `Col.`, `General.` 等。
权当是检查首字母大写了。本来这个功能就是针对这一格式要求的。

### 格式检测

1. 中文行存在任何除书名号外的其他全角符号，均应警告；
2. 英文行任何全角字符都应警告；
3. 字幕序号为递增整数；
4. 首字母大写，且上一句结尾出现下列情况之一的，需要警告：
    a. 没有标点符号
    b. 有逗号或者连字符
5. 删除行首尾空格；
6. 小写i替换为I。

### 拆轴合轴
对单行字幕进行拆轴时，用户分别指定英文行和中文行打拆轴点，然后按照英文行的拆轴点拆分时间段。将拆分出的两个时间轴作为两行单独字幕插入原位置。

合轴即简单地将中英文字幕分别合成为一轴。

## 播放器
<del>使用开源的HTML5播放器Video.js。</del>
<del>Angular可以很好的支持异步请求，只需要一个`$http`语句。那么这就为实时更新字幕创造了条件。但是需要考虑两个问题：  </del>
问题仍然存在：
1. 虽然这个App没有实际上的后端，但是用户的srt文件是不是需要上传到服务器缓存呢？这会不会给服务器带来过大压力？
2. 如何进行实时更新字幕？可以有两个思路：
    a. 在每次用户点击播放器的播放按钮的时候，自动保存当前editor的内容作为字幕文件，然后发起http请求获取最新保存的字幕放到`<track>`元素中。
    b. 新增一个保存按钮，当点击该按钮时才保存。但是每当用户点击播放器的播放按钮时都要重新请求`<track>`元素的路径。
