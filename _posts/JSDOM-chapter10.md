---
title: "JavaScript DOM 编程艺术 笔记-第十章"
date: 2017-03-20 14:06:00
cover: "5.jpg"
category: "JavaScript"
tags:
    - JavaScript
---
# JavaScript动画
本章的主要内容是利用JavaScript添加一些简单的动画。

这本书的很多内容从一开始提出到整本书写完，是贯穿始终的，比如平稳退化（优雅降级）和渐进增强。这一章使用前面给出的各种DOM方法，结合元素自身属性创建了一个轮播图样式的动画。这其中涉及到的一些细节，总结如下。
<!--more-->
## 注意`setTimeout()`的全局性与变量作用域
由于我们只关注其中值得注意的细节，所以只简单介绍一下应用场景。
我们要实现的是一个类似轮播图的组件，提供三个链接，在鼠标移到链接上时，轮播图滚动显示到相应链接对应的内容。我们用简单的方式来实现这个动画，其中使用了`setTimeout()`。

动画的实现方式是简单的每隔若干ms移动一段距离。于是这里就使用了类似
{% codeblock lang:javascript %}
function moveMessage() {
...
movement = setTimeout("moveMessage()", 10);
...
}
{% endcodeblock %}
这样的间隔递归调用， 每隔10ms调用一次自己。但是可以发现这里的`movement`是个全局变量，当时这样声明是因为作为全局变量，它可以在任何位置被`clearTimeout()`停止。否则，每次鼠标移动到连接上，都会在事件队列种增加一个递归调用任务，会出现轮播图抽搐的效果。这是因为频繁激活了`onmouseover`绑定的函数，事件累积起来，它们会会试图把图片同时移动到两个不同的目的地。
虽然它是作为一个全局变量声明的，但是如果真的使用`cleartTimeout()`来停止它，我们并不能预先知道这一对函数究竟哪一个先运行，如果是`clearTimeout(movement)`先运行，就会报错，因为此时`movement`还未被定义。   
另一种方式同样也行不通：将`movement`作为局部变量声明，因为其他上下文中的`clearTimeout()`将找不到`movement`而无法工作。

解决的方式是用到**“属性”**。
我们为轮播图元素创建一个同名属性，将上面的`movement`赋值给它，然后每当使用`clearTimeout()`前都检测一下这个元素属性。这样在多个`onmouseover`事件被频繁激活时，新激活的事件执行的同时也会结束上一个事件的`setTimeout()` ，因此同时运行的也只有一个`setTimeout()`递归过程，不会出现抽搐。

## 轮播图的简单原理
最简单的如本例，实际上有点像一个CSS sprite，它把四幅图放在了一幅图中，通过设置父级元素的大小和`overflow`属性为`hidden`来固定窗口，然后JavaScript控制背景图的左右位置来实现轮播。
其他的轮播图思路，我想还有：
1. 多幅图重叠放置，控制不同图片的透明度
2. 同上，控制`z-index`
3. 多幅图水平放置在一个容器中，控制容器的左右位置，将特定的内容显示在窗口中

存在的问题：
1. 可扩展性：本例中的最简单的方法缺点是 可扩展性太差，使用CSS sprite类似的方法，在有新图片时得先处理出一个sprite图，每次内容有变化都得重新处理。
2. 无限循环的问题：最简单的窗口式轮播图比如12345，如果是按照一个方向滚动，滚动到5的时候再滚动到1就会出现倒滚，有时这种效果是不怎么好看的。网上看到的一个解决思路是，在12345前后各加一张图5和1组成5123451。当从左到右滚动到倒数第二个5时，无动画切换到最开始的5，也就是暗中将用户视角中的最后一幅幅图改成了页面逻辑中的第一幅图；当反向（从右到左）滚动到第一个5时，暗中改成倒数第二个5；对于两个图1，也是同理。

## 平稳退化
本章对于这一点同样提及很多，因为轮播图本身是与JavaScript耦合比较紧密的东西，如果JavaScript不可用，会对页面效果造成很大影响。基本上要遵守以下原则：
1. 添加安全检查，检查DOM方法是否存在，检查要操作的元素是否存在，检查元素属性是否已经被设置，如未被设置是否有默认值。
2. 让JavaScript对DOM的操作限制在JavaScript里。这一点个人感觉还是非常有必要的。逻辑是：
    * 如果把所有JavaScript将要操作的元素都写在HTML里（书中称为硬编码），那么在JavaScript不可用时，这些HTML元素势必成为页面中多余的部分；
    * 如果JavaScript可用，那么就让JavaScript自己来生成这些HTML元素

这样做的好处是，在JavaScript可用的条件下，轮播图将正常显示；在JavaScript不可用的条件下，轮播图处可以静态显示，或者添加一些其他的效果或提示。这就保证了最基本的“可用性”，这一点是非常重要的。
